<html lang="en">
  <script>

    var Module = {
        onRuntimeInitialized: function() {
            console.log('essentiamin.js and .wasm files are loaded sucessfully ...');
            loadSoundFromUri(sampleFreesoundUri);
        }
    };

  </script> 
  <link rel="shortcut icon" href="src/img/essentia.js.ico">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Edit your site info here -->
    <meta name="essentia.js" content="essentia.js-examples">

    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.css"/>
    <link rel="stylesheet" type="text/css" href="src/css/main.css"/>

    <title>essentia.js - Demos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/2.2.1/wavesurfer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/2.2.1/plugin/wavesurfer.microphone.min.js"></script>
    <script type="text/javascript" src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/zeu"></script>
    <script src="dist/essentiamin.js"></script>
    <script src="src/js/app.js"></script>
    <script src="src/js/essentiatools.js"></script>
    <script src="src/js/echarts.js"></script>
    <script src="src/js/chartoptions.js"></script>
    <script src="src/js/dataviz.js"></script>
  </head>
  <body>  
      <script>

      // 20 mb file upload limit
      FILE_UPLOAD_LIMIT = 20;
      var chartJsCtx;
      var audioCtx;
      var wavesurfer;
      var myChartObj;

      $(document).ready(function () {


            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
                optionsTemplate.sampleRate = audioCtx.sampleRate;
                } catch (e) {
                throw 'Could not instantiate AudioContext: ' + e.message;
            }


            // if (audioCtx.state === 'suspended') {
            //     // resume audioCtx for chrome support
            // }


            // for the menu tabs
            $('.menu .item').tab();

            // create wavesurfer instance
            wavesurfer = WaveSurfer.create({
                audioContext: audioCtx,
                container: '#audio-obj',
                waveColor: 'grey',
                progressColor: '#2B6FAC',
                cursorColor: '#fff',
                barWidth: 2,
                plugins: [
                    WaveSurfer.microphone.create({
                        'buffersize': 4096,
                    })
                ]
            });


            // pre-load a audio file at load
            // $('#info-msg').hide();
            // wavesurfer.load(sampleFreesoundUri);
            // if (appStatus.audioLoaded) { removeAudioButtons(); };
            // createAudioButtons();
            // appStatus.audioLoaded = true;

            $('#recordButton').click(function () {
                // recordAudioWaveSurf();
                appStatus.uploadMode = 'mic';
                recordAudioWaveSurf();
                recordStop();
                $('#info-msg').hide();
            });
            $('#file-menu').change(function () {
                appStatus.uploadMode = 'file';
                uploadAudioFileFromMenu($("#file-menu"), 'popup');
                $('#info-msg').hide();
            });
            $('#file-uploader').on(
                'dragover',
                function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
            );
            $('#file-uploader').on(
                'dragenter',
                function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
            )
            $('#file-uploader').on(
                'drop',
                function (e) {
                    if (e.originalEvent.dataTransfer) {
                        if (e.originalEvent.dataTransfer.files.length) {
                            e.preventDefault();
                            e.stopPropagation();
                            /*UPLOAD FILES HERE*/
                            appStatus.uploadMode = 'file';
                            uploadAudioFileFromMenu(e.originalEvent.dataTransfer.files[0], 'dragndrop');
                            $('#info-msg').hide();
                        }
                    }
                }
            );

            // toggle switch for using real-time mode
            $('#realtime-tab').checkbox({
                onChecked: function () {appStatus.realtime = true; 
                    console.log("Appstatus.realtime: ", appStatus.realtime)},
                onUnchecked: function () {appStatus.realtime = false; 
                    console.log("Appstatus.realtime: ", appStatus.realtime)}
            });

            
            $('#melody-tab').on('click', function() {
                console.log("clicked");
                // $.tab({
                //     'onVisible': function() {
                //         // plot melody
                //         console.log("clicked on plot");
                //         plotLineChartMelody(urlAudioBuffer.getChannelData(0));
                //     }
                // });
            });


        });
    </script> 

    <div class="ui main_wrapper landing-image">

    <div class="ui header centered" id="header">
        <a target="_blank" href="//github.com/MTG/essentia.js">
            <img id="header-img" src="src/img/essentiajsbanner.png">
        </a>
        <div>
            <center>
                <h2 class="ui header white-text">Audio/Music analysis on your web-browser</h2>
            </center>
        </div>
        <div class="ui divider" style="height: 2px; width: 2px"></div>
    </div>

    <br>

    <div class="body-container">

        <div class="ui two column grid container content-container">

            <div id="control_btns" class="control_btns six wide left aligned column">
                <div class="ui basic centered grid">
                    <div class="ui floated compact" style="color: azure!important;">
                        <div id="realtime-tab" class="ui toggle checkbox">
                            <input type="checkbox" name="public">
                            <label style="color: azure!important;">Real-time</label>
                        </div>
                    </div>
                    <div class="ui vertical buttons row">
                        <button id="recordButton" class="ui vertical red inverted big button record-button">Record
                            &nbsp;&nbsp;<i class="microphone icon"></i></button>
                    </div>
                </div>

                <div class="ui horizontal divider" style="color: papayawhip;">OR</div>

                <div class="ui basic segment row">
                    <div class="ui-widget" id="file-uploader">
                        <p style="position:absolute; padding: 12px; width:85%;"><br><br>Drag'n'Drop a file or click to select a file from your computer</p>
                        <input type="file" id="file-menu"/>
                    </div>
                </div>
                <div class="ui left basic row segment">
                    <p hidden id="status_demo" class="white-text"><span id="update_status"></span></p>
                </div>
            </div>

            <div id="results" class="ui ten wide column basic segment result-segment">

                <div id="init-res-div" class="ui centered segment" style="width: 450px; height: 200px; background-color: transparent">
                    <!-- <canvas id="test-canvas"></canvas> -->
                    <div id="audio-obj" class="ui row" style="margin-bottom: 40px;">
                            <center>
                                <audio hidden id="audio-div" controls>
                                    <source id="audio-source" src="" type="audio/wav"/>
                                </audio>
                            </center>
                    </div>
                    <div id="info-msg" class="ui info message">
                        <i class="close icon"></i>
                        <center>
                        Record audio from your native microphone 
                                    or 
                        upload an audio file! (recommended to upload short audio files)
                        </center>
                    </div>            
                </div>

                <div id="result-tab-menu" class="ui top attached tabular white menu">
                    <a id="melody-tab" class="item active" data-tab="first" style="color: indianred">Melody</a>
                    <a class="item" data-tab="second" style="color: indianred">Key</a>
                    <a class="item" data-tab="third" style="color: indianred">BPM Histogram</a>
                    <a class="item" data-tab="fourth" style="color: indianred">Loudness</a>
                    <a class="item" data-tab="fifth" style="color: indianred">Log Mel Bands</a>
                </div>
        
                <div id="melody-div" class="ui bottom attached tab segment active" data-tab="first" style="width: 900px; height: 350px; background-color: transparent">
                </div>
                <div id="key-div" class="ui bottom attached tab segment" data-tab="second" style="width: 900px; height: 350px; background-color: transparent">
                </div>
                <div id="bpm-div" class="ui bottom attached tab segment" data-tab="third" style="width: 900px; height: 350px; background-color: transparent"> 
                </div>
                <div id="loudness-div" class="ui bottom attached tab segment" data-tab="fourth" style="width: 900px; height: 350px; background-color: transparent">
                </div>
                <div id="mfcc-div" class="ui bottom attached tab segment" data-tab="fifth" style="width: 900px; height: 350px; background-color: transparent">
                </div>
            </div>

        </div>

        <center>
        <div class="footer">
            <a class="demo_logo" target="_blank" href="//essentia.upf.edu">
                <img id="logo" src="https://essentia.upf.edu/documentation/_static/essentia_logo.svg" alt="MTG Logo"
                     style="margin-left: 40px; height: 70px;">
            </a>
            <a target="_blank" href="https://www.upf.edu/web/mtg">
                <img class="essnt-footer_mtg-logo" src="https://mtg.github.io/assets/img/upflogo.png" alt="mtg logo"
                     style="width:300px; height: 70px;">
            </a>
        </div>
        </center>

    </div>

</div>   
  </body>
</html>